
# This script borrows heavily from a similar script from MB1

```{r chunk-opts, echo=FALSE}
opts_chunk$set(echo = FALSE)
```

```{r read_data}
d <- read_csv(here("processed_data","02_validated_output.csv"))
source(here("helper/preprocessing_helper.R"))
```

```{r lab_stats}
# Cache lab stats pre-exclusion for lab-based exclusions. 

lab_contribs_pre_exclusion <- d %>%
  group_by(lab) %>%
  summarise(n = length(unique(subid)))
```

```{r pilot}
# We exclude kids who are explicitly marked as pilot.
d <- exclude_by(d, quo(pilot), quiet = TRUE)
```

```{r age}
# We exclude kids who are outside of the 3-6 or 9-15 month age range. 
d$out_of_age <- d$age_mo < 6 | d$age_mo > 15
d$out_of_age <- d$age_mo > 9 & d$age_mo < 12

d <- exclude_by(d, quo(out_of_age), quiet=TRUE)
```


```{r}
lang_incl <- exclude_by(d, quo(lang_incl), action = "include", 
                   return_pcts = TRUE, 
                   quiet = TRUE)
d <- lang_incl$data
```

* *Language background*. There were `r lang_incl$percents$any_sum` (`r round(lang_incl$percents$any_mean*100, 1)`%) who were tested but did not meet our inclusion criteria for either the monolingual or bilingual group.  For example, an infant who heard English 20% of the time and Italian 80% of the time woudl not meet the criteria as either monolingual (at least 90% exposure to one language) or bilingual (at least 25% exposure to each of two languages).


```{r}
full_term <- exclude_by(d, quo(full_term), action = "include", 
                return_pcts = TRUE, 
                quiet = TRUE)

d <- full_term$data
```

* *Full-term*. We defined full term as gestation times greater than or equal to 37 weeks. `r full_term$percents$any_sum` (`r round(full_term$percents$any_mean*100, 1)`%) infants were tested but did not meet this criterion.

```{r}
ndd <- exclude_by(d, quo(td), action = "include", 
                return_pcts = TRUE, 
                quiet = TRUE)

d <- ndd$data
```

* *No diagnosed developmental disorders*. We excluded data from `r ndd$percents$any_sum` (`r round(ndd$percents$any_mean*100, 1)`%) infants with with parent-reported developmental disorders or sensory impairments.

```{r trial_errors}
trial_err <- exclude_by(d, quo(trial_error), 
                  setting = "any", 
                  return_pcts = TRUE, 
                  quiet = TRUE)

d <- trial_err$data
```


```{r usable_pairs}
usable_pairs <- d %>%
  filter(trial_type != "TRAIN") %>%
  group_by(lab, subid, stimulus_num) %>%
  summarise(n_usable = sum(!is.na(looking_time))) %>%
  summarise(usable_pair = any(n_usable == 2))
```


```{r usable_pairs2}
d <- d %>% 
  left_join(usable_pairs) 

usablepair <- exclude_by(d, quo(usable_pair), action = "include", 
                         return_pcts = TRUE, 
                         quiet = TRUE)

d <- usablepair$data
```

* *Contributed usable data*. A child must have contributed non-zero looking time on a pair of test trials (i.e., one trial each of IDS and ADS from a particular stimulus pair), after trial-level exclusions were applied, to be included in the study. `r usablepair$percents$any_sum` (`r round(usablepair$percents$any_mean*100, 2)`%)  infants were tested but did not meet these criteria. We adopted this relatively liberal inclusion criterion even though it is at variance with the more stringent standards that are typically used in infancy research. We were interested in maximizing the amount of data from each lab we were able to include in the initial analysis, and our paradigm was by design less customized for any particular age group (and hence likely to produce greater data loss, especially for older children). In the exploratory analyses below, we consider how exclusion decisions affected our effect size estimates.


```{r}
#store an additional dataframe containing information on session error types
session_error_type <- d %>%
  filter(session_error) %>%
  distinct(lab, subid,session_error_type_recoded) %>%
  count(session_error_type_recoded)

sessionerr <- exclude_by(d, quo(session_error), 
                         action = "exclude", 
                         return_pcts = TRUE, 
                         quiet = TRUE)

d <- sessionerr$data
```

There were  `r sessionerr$percents$any_sum` (`r round(sessionerr$percents$any_mean*100, 2)`%) infants excluded from the analysis due to issues such including equipment (`r session_error_type$n[session_error_type$session_error_type_recoded=="equipment failure"]` experimenter error, `r session_error_type$n[session_error_type$session_error_type_recoded=="experimenter error"]` infants for or parental/outside interference `r session_error_type$n[session_error_type$session_error_type_recoded=="outside interference"]`.



