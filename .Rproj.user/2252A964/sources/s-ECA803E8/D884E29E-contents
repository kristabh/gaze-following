## Loads data for Mix-14 and Mix-20
## Replaces eyetracking-r clean_by_trackloss function
## 1. Reads in file, including only the necessary columns (keepcols)
## 2. Cleans MediaNames
## 3. Determines rows with trackloss
## 4. Changes coordinates to a cartesian system, so origin is bottom left (height of screen is 1200)
## 5. Saves a final clean dataset as an .Rda file

## Clean the workspace and set working directory
rm(list=ls(all=T))
#rawdata_location <- "~/Desktop/Mix"  #Where Tobii can read raw data from
rawdata_location <- ("/Users/krista/Dropbox/Documents/Concordia/Lab/Projects/Mix20/FullMixDataset") #This is where dataset will be saved

## Load libraries
library(readr) # For read_tsv function
library(dplyr)

## Read files from working directory, code based on https://www.r-bloggers.com/merge-all-files-in-a-directory-using-r-into-a-single-dataframe/

keepcols=c("RecordingName","MediaName","RecordingTimestamp","ValidityLeft", # The columns we need for the analysis
           "ValidityRight","GazePointX (ADCSpx)","GazePointY (ADCSpx)", "PupilLeft", "PupilRight") 

file_list <- list.files(rawdata_location, pattern = "*tsv") # Lists files that contain word "Data".  Needed because Mix is in several files

setwd(rawdata_location)
for (file in file_list){

  # if the merged dataset does exist, append to it
  if (exists("dataset")){
    temp_dataset <-read_tsv(file, col_names=TRUE)[ , keepcols]
    dataset<-rbind(dataset, temp_dataset)
    rm(temp_dataset)
  }
  
  # if the merged dataset doesn't exist, create it
  if (!exists("dataset")){
    dataset <- read_tsv(file, col_names=TRUE)[ , keepcols]
  }
}


## Cleaning MediaNames, removing attention getters (This routine is UNIQUE for the MIX study).  Strange filenames (e.g. LF) will be worked out with trial_order file
dataset$MediaName <- gsub("2).AVI","",dataset$MediaName)
dataset$MediaName <- gsub("3).AVI", "", dataset$MediaName)
dataset$MediaName <- gsub("8).AVI","",dataset$MediaName)
dataset$MediaName <- gsub("\\(","",dataset$MediaName)
dataset$MediaName <- gsub("\\)","",dataset$MediaName)
dataset$MediaName <- gsub(".AVI","",dataset$MediaName)
dataset$MediaName <- gsub(" ","_",dataset$MediaName)
dataset$MediaName <- gsub(",","",dataset$MediaName)
dataset <- dataset[dataset$MediaName!="attngetter169",] ## Eliminate attention getters

## Making columns into factors
dataset$MediaName <- as.factor(dataset$MediaName)
dataset$RecordingName = as.factor(dataset$RecordingName)
colnames(dataset)[colnames(dataset) == "GazePointX (ADCSpx)"] = "GazePointX" ## Renaming the column
colnames(dataset)[colnames(dataset) == "GazePointY (ADCSpx)"] = "GazePointY" ## Renaming the column

## Cleaning rows by getting rid of rows with no MediaNames
dataset <- dataset[dataset$MediaName != "",] ## Get rid of rows with blank MediaNames
dataset <- dataset[!is.na(dataset$MediaName), ] ## Get rid of rows with NA MediaNames

## Creating trackloss column
dataset$trackloss <- FALSE # Initially assume no trackloss
dataset$trackloss[is.na(dataset$GazePointX)] <- TRUE  ## Rows without an x coordinate have trackloss
dataset$trackloss[is.na(dataset$GazePointY)] <- TRUE ## Rows without a y coordinate have trackloss
dataset$trackloss[dataset$GazePointX < 0 | dataset$GazePointX > 1920] <- TRUE ## Consider observations with out of range gaze points trackloss
dataset$trackloss[dataset$GazePointY < 0 | dataset$GazePointY > 1200] <- TRUE ## Consider observations with out of range gaze points trackloss
dataset$trackloss[dataset$ValidityLeft > 1 && dataset$ValidityRight > 1] <- TRUE ## Observations with low validity codes considered trackloss

## Finalizing dataset
dataset <- as.data.frame(lapply(dataset,function(x) x[,drop=TRUE])) ## drop unsused levels
dataset <- select(dataset, -ValidityLeft, -ValidityRight) ## Removing validity code columns from dataset
dataset$GazePointY <- 1200 - dataset$GazePointY # Put GazePoint is on a cartesian coordinate system instead of Tobii system

save(dataset, file = "../data/MixData.Rda") #Saves Mix dataset to data directory
